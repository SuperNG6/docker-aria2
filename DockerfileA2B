FROM superng6/alpine:3.22 AS builder

# download static aria2c && AriaNg AllInOne
RUN apk add --no-cache curl wget unzip \
    && ARIANG_VER=$(wget -qO- https://api.github.com/repos/mayswind/AriaNg/tags | grep 'name' | cut -d\" -f4 | head -1 ) \
    && wget -P /tmp https://github.com/mayswind/AriaNg/releases/download/${ARIANG_VER}/AriaNg-${ARIANG_VER}-AllInOne.zip \
    && unzip /tmp/AriaNg-${ARIANG_VER}-AllInOne.zip -d /tmp \
    && A2B_VER=$(wget -qO- https://api.github.com/repos/makeding/aria2b/tags | grep 'name' | cut -d\" -f4 | head -1 ) \
    && wget -P /tmp https://github.com/makeding/aria2b/releases/download/${A2B_VER}/aria2b \
    && curl -fsSL https://git.io/docker-aria2c.sh | bash \
    && echo "docker-aria2-$(date +"%Y-%m-%d")" > /tmp/build-date \
    && echo "docker-ariang-$ARIANG_VER" >> /tmp/build-date \
    && echo "docker-aria2b-$A2B_VER" >> /tmp/build-date

# install static aria2c
FROM superng6/alpine:3.22

# set label
LABEL maintainer="NG6"
ENV TZ=Asia/Shanghai UT=true SECRET=yourtoken CACHE=128M QUIET=true \
    SMD=true RUT=true A2B=true CRA2B=2h \
    PORT=6800 WEBUI=true WEBUI_PORT=8080 BTPORT=32516 \
    PUID=1026 PGID=100

# copy stable files first
COPY --from=builder /tmp/index.html /www/index.html
COPY --from=builder /tmp/aria2b /usr/local/bin/aria2b
COPY --from=builder /tmp/build-date /aria2/build-date
COPY --from=builder /usr/local/bin/aria2c /usr/local/bin/aria2c

# install packages
RUN apk add --no-cache darkhttpd jq findutils iptables ip6tables ipset nodejs \
    && chmod a+x /usr/local/bin/aria2c \
    && chmod a+x /usr/local/bin/aria2b \
    && rm -rf /var/cache/apk/* /tmp/*

# copy application files
COPY root/ /
COPY aria2b/ /etc/services.d/aria2b/

# volume
VOLUME /config /downloads /www

EXPOSE 8080 6800 32516 32516/udp
