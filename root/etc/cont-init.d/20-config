#!/usr/bin/with-contenv bash
# shellcheck shell=bash
# shellcheck disable=SC1091
# 初始化目录、配置与日志文件（仅在容器启动）
set -euo pipefail
. /aria2/scripts/lib/logger.sh
# 供 config_apply_setting_defaults 使用的依赖
. /aria2/scripts/lib/common.sh
. /aria2/scripts/lib/config.sh

# 此处不再手工定义路径，统一由 path.sh/config.sh 内的 get_base_paths 提供

# 目录
mkdir -p "${CONFIG_DIR}/ssl" "${LOG_DIR}" "${BAK_TORRENT_DIR}" "${DOWNLOAD_PATH}/completed" "${DOWNLOAD_PATH}/recycle"

# 配置文件按模板初始化
[[ -f "${ARIA2_CONF}" ]] || cp /aria2/conf/aria2.conf.default "${ARIA2_CONF}"
[[ -f "${SETTING_FILE}" ]] || cp /aria2/conf/setting.conf "${SETTING_FILE}"
[[ -f "${FILTER_FILE}" ]] || cp /aria2/conf/文件过滤.conf "${FILTER_FILE}"

# 必需空文件
[[ -f "${SESSION_FILE}" ]] || : > "${SESSION_FILE}"
[[ -f "${DHT_FILE}" ]] || : > "${DHT_FILE}"

# setting.conf 缺省回填/容错回写：
# 将模板复制为临时文件 → 覆盖用户现有值 → 为缺失键填默认值 → 原子替换回 setting.conf
config_load_setting || true
config_apply_setting_defaults || true
